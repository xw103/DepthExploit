/**
 * 在所有继承自DepthActivity的类中，`this`已弃用，并使用`that`代替
 * 例如：Toast.makeText(that,"test",Toast.LENGTH_SHORT).show();
 */

package org.exploit.depth.example;

import android.os.Bundle;
import android.os.RemoteException;
import android.util.Log;
import android.widget.Toast;

import org.exploit.depth.activity.DepthActivity;
import org.exploit.depth.internal.RootIPCReceiver;
import org.exploit.depth.utils.IPCUtils;

import java.io.IOException;

import bin.androidlua.LuaRunner;
import bin.luajava.LuaException;

public class MainActivity extends DepthActivity {

    private final RootIPCReceiver<Test> ipcReceiver = new RootIPCReceiver<Test>(that, 0) {
        @Override
        public void onConnect(Test ipc) {
            try {
                Log.e("test",ipc.test());
                Toast.makeText(that, ipc.test(), Toast.LENGTH_SHORT).show();
            } catch (RemoteException e) {
                e.printStackTrace();
            }
        }

        @Override
        public void onDisconnect(Test ipc) {

        }
    };

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        try {
            LuaRunner runner = new LuaRunner(this);
            runner.run("print(888)".getBytes(),"test");
            runner.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
        IPCUtils.startIPC(that, ipcReceiver, null, null, line -> {
            //接收输出（可为NULL）
            System.out.println(line);
        });
    }
}