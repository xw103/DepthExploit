/**
 * 在所有继承自DepthActivity的类中，`this`已弃用，并使用`that`代替
 * 例如：Toast.makeText(that,"test",Toast.LENGTH_SHORT).show();
 */

package org.exploit.depth.example;

import android.os.Bundle;
import android.os.RemoteException;
import android.util.Log;
import android.view.Surface;
import android.widget.Toast;

import org.exploit.depth.activity.DepthActivity;
import org.exploit.depth.internal.RootIPCReceiver;
import org.exploit.depth.utils.IPCUtils;
import org.exploit.depth.widget.SurfaceBufferView;

import bin.androidlua.LuaRunner;

public class MainActivity extends DepthActivity {

    private final RootIPCReceiver<Test> ipcReceiver = new RootIPCReceiver<Test>(that, 0) {
        @Override
        public void onConnect(Test ipc) {
            try {
                Log.e("test",ipc.test());
                Toast.makeText(that, ipc.test(), Toast.LENGTH_SHORT).show();
            } catch (RemoteException e) {
                e.printStackTrace();
            }
        }

        @Override
        public void onDisconnect(Test ipc) {

        }
    };

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        new SurfaceBufferView(that, new SurfaceBufferView.SurfaceBufferListener() {
            @Override
            public void onSurfaceCreate(Surface surface) {

            }

            @Override
            public void onSurfaceChanged(Surface surface) {

            }

            @Override
            public boolean onSurfaceDestroyed(Surface surface) {
                return false;
            }

            @Override
            public void onSurfaceUpdated(Surface surface) {

            }
        });

        try {
            LuaRunner runner = new LuaRunner();
            runner.run("print(888)".getBytes(),"test");
            runner.close();
        } catch (Exception e) {
            e.printStackTrace();
        }

        IPCUtils.startIPC(that, ipcReceiver, null, null, line -> {
            //接收输出（可为NULL）
            System.out.println(line);
        });
    }
}